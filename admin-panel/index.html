<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shellia AI - Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span class="logo-icon">ü§ñ</span>
                <span class="logo-text">Shellia AI</span>
            </div>
            
            <nav class="nav">
                <a href="#overview" class="nav-item active" data-page="overview">
                    <span class="nav-icon">üìä</span>
                    <span>Vue d'ensemble</span>
                </a>
                <a href="#users" class="nav-item" data-page="users">
                    <span class="nav-icon">üë•</span>
                    <span>Utilisateurs</span>
                </a>
                <a href="#payments" class="nav-item" data-page="payments">
                    <span class="nav-icon">üí∞</span>
                    <span>Paiements</span>
                </a>
                <a href="#security" class="nav-item" data-page="security">
                    <span class="nav-icon">üîí</span>
                    <span>S√©curit√©</span>
                </a>
                <a href="#analytics" class="nav-item" data-page="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </a>
                <a href="#config" class="nav-item" data-page="config">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Configuration</span>
                </a>
                <a href="#tasks" class="nav-item" data-page="tasks">
                    <span class="nav-icon">‚è∞</span>
                    <span>T√¢ches</span>
                    <span class="nav-badge" id="task-badge">0</span>
                </a>
                <a href="buttons.html" class="nav-item">
                    <span class="nav-icon">üîò</span>
                    <span>Boutons</span>
                </a>
                <a href="tickets.html" class="nav-item">
                    <span class="nav-icon">üé´</span>
                    <span>Tickets</span>
                </a>
                <a href="embeds.html" class="nav-item">
                    <span class="nav-icon">üì¶</span>
                    <span>Embeds</span>
                </a>
                <a href="affiliates.html" class="nav-item">
                    <span class="nav-icon">ü§ù</span>
                    <span>Affiliation</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">üö™ D√©connexion</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Header -->
            <header class="header">
                <h1 class="page-title">Tableau de Bord</h1>
                <div class="header-actions">
                    <div class="user-info" id="user-info"></div>
                    <span class="status-badge online">‚óè En ligne</span>
                    <span class="version">v2.0-Security</span>
                    <button onclick="logout()" class="btn-logout-header" title="D√©connexion">üö™</button>
                </div>
            </header>

            <!-- Pages -->
            <div class="content">
                <!-- Overview Page -->
                <div id="overview-page" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <h3 id="stat-users">-</h3>
                                <p>Utilisateurs totaux</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí¨</div>
                            <div class="stat-info">
                                <h3 id="stat-messages">-</h3>
                                <p>Messages aujourd'hui</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <h3 id="stat-revenue">-</h3>
                                <p>Revenus ce mois</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚ö°</div>
                            <div class="stat-info">
                                <h3 id="stat-cost">-</h3>
                                <p>Co√ªt API aujourd'hui</p>
                            </div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-card">
                            <h3>Messages (7 derniers jours)</h3>
                            <canvas id="messages-chart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Distribution des plans</h3>
                            <canvas id="plans-chart"></canvas>
                        </div>
                    </div>

                    <div class="recent-activity">
                        <h3>Activit√© r√©cente</h3>
                        <div id="activity-list" class="activity-list">
                            <p class="loading">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="users-page" class="page">
                    <div class="page-header">
                        <h2>Gestion des Utilisateurs</h2>
                        <div class="search-box">
                            <input type="text" id="user-search" placeholder="Rechercher un utilisateur...">
                            <button onclick="searchUsers()">üîç</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Plan</th>
                                    <th>Messages</th>
                                    <th>Inscription</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="loading">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination">
                        <button onclick="prevPage()">‚Üê Pr√©c√©dent</button>
                        <span id="page-info">Page 1</span>
                        <button onclick="nextPage()">Suivant ‚Üí</button>
                    </div>
                </div>

                <!-- Payments Page -->
                <div id="payments-page" class="page">
                    <div class="page-header">
                        <h2>Paiements & Abonnements</h2>
                    </div>
                    
                    <div class="stats-row">
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="payment-total">-</span>
                            <span class="mini-stat-label">Total ce mois</span>
                        </div>
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="payment-count">-</span>
                            <span class="mini-stat-label">Transactions</span>
                        </div>
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="payment-conversion">-</span>
                            <span class="mini-stat-label">Conversion</span>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="payments-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Utilisateur</th>
                                    <th>Plan</th>
                                    <th>Montant</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="loading">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Security Page -->
                <div id="security-page" class="page">
                    <div class="page-header">
                        <h2>Centre de S√©curit√©</h2>
                    </div>
                    
                    <div class="security-status">
                        <div class="security-card">
                            <h4>üîê Chiffrement</h4>
                            <span class="status ok">Actif</span>
                            <p>Cl√©s API chiffr√©es avec Fernet</p>
                        </div>
                        <div class="security-card">
                            <h4>üõ°Ô∏è Rate Limiting</h4>
                            <span class="status ok">Actif</span>
                            <p>Persistant avec Redis/Supabase</p>
                        </div>
                        <div class="security-card">
                            <h4>‚ö° Circuit Breaker</h4>
                            <span class="status" id="circuit-status">V√©rification...</span>
                            <p>Protection contre les cascades</p>
                        </div>
                        <div class="security-card">
                            <h4>‚úÖ Webhooks Stripe</h4>
                            <span class="status ok">Valid√©s</span>
                            <p>Signature HMAC-SHA256</p>
                        </div>
                    </div>
                    
                    <div class="security-alerts">
                        <h3>üö® Alertes R√©centes</h3>
                        <div id="security-alerts-list">
                            <p class="loading">Chargement...</p>
                        </div>
                    </div>
                    
                    <div class="security-logs">
                        <h3>üìã Logs de S√©curit√©</h3>
                        <div class="table-container">
                            <table id="security-logs-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>√âv√©nement</th>
                                        <th>S√©v√©rit√©</th>
                                        <th>Utilisateur</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Analytics Page -->
                <div id="analytics-page" class="page">
                    <div class="page-header">
                        <h2>Analytics Avanc√©es</h2>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-card large">
                            <h3>Utilisateurs actifs (30 jours)</h3>
                            <canvas id="users-chart"></canvas>
                        </div>
                        <div class="chart-card large">
                            <h3>Co√ªts API (7 jours)</h3>
                            <canvas id="costs-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-box">
                            <h4>Messages / Utilisateur</h4>
                            <span id="metric-msg-per-user">-</span>
                        </div>
                        <div class="metric-box">
                            <h4>Taux de r√©tention</h4>
                            <span id="metric-retention">-</span>
                        </div>
                        <div class="metric-box">
                            <h4>Co√ªt moyen / Message</h4>
                            <span id="metric-cost-per-msg">-</span>
                        </div>
                        <div class="metric-box">
                            <h4>Temps de r√©ponse moyen</h4>
                            <span id="metric-response-time">-</span>
                        </div>
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="tasks-page" class="page">
                    <div class="page-header">
                        <h2>‚è∞ T√¢ches Planifi√©es</h2>
                        <button onclick="showCreateTaskModal()" class="btn-primary">
                            <span>‚ûï Nouvelle t√¢che</span>
                        </button>
                    </div>

                    <!-- Stats des t√¢ches -->
                    <div class="stats-row">
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="task-total">-</span>
                            <span class="mini-stat-label">T√¢ches actives</span>
                        </div>
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="task-running">-</span>
                            <span class="mini-stat-label">En cours</span>
                        </div>
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="task-success">-</span>
                            <span class="mini-stat-label">Succ√®s 24h</span>
                        </div>
                        <div class="mini-stat">
                            <span class="mini-stat-value" id="task-failed">-</span>
                            <span class="mini-stat-label">√âchecs 24h</span>
                        </div>
                    </div>

                    <!-- T√¢ches actives -->
                    <div class="config-section">
                        <div class="section-header">
                            <h3>üìã T√¢ches Actives</h3>
                            <div class="section-actions">
                                <button onclick="loadTasks()" class="btn-icon" title="Rafra√Æchir">üîÑ</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="tasks-table">
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>Type</th>
                                        <th>Fr√©quence</th>
                                        <th>Prochaine ex√©cution</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Historique des ex√©cutions -->
                    <div class="config-section">
                        <div class="section-header">
                            <h3>üìú Historique des Ex√©cutions</h3>
                            <div class="filter-tabs">
                                <button class="tab-btn active" onclick="filterExecutions('all')">Tous</button>
                                <button class="tab-btn" onclick="filterExecutions('completed')">‚úÖ Succ√®s</button>
                                <button class="tab-btn" onclick="filterExecutions('failed')">‚ùå √âchecs</button>
                                <button class="tab-btn" onclick="filterExecutions('running')">‚è≥ En cours</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="executions-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>T√¢che</th>
                                        <th>Type</th>
                                        <th>Dur√©e</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Templates disponibles -->
                    <div class="config-section">
                        <h3>üì¶ Templates de T√¢ches</h3>
                        <div class="templates-grid" id="templates-grid">
                            <p class="loading">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Configuration Page -->
                <div id="config-page" class="page">
                    <div class="page-header">
                        <h2>‚öôÔ∏è Configuration API</h2>
                        <div class="header-warning">
                            <span class="warning-badge">‚ö†Ô∏è Zone sensible - Les changements affectent imm√©diatement le bot</span>
                        </div>
                    </div>

                    <!-- Master Key Section -->
                    <div class="config-section">
                        <h3>üîê Cl√© Ma√Ætre de Chiffrement</h3>
                        <p class="config-description">N√©cessaire pour chiffrer/d√©chiffrer les cl√©s API. Ne la partagez jamais.</p>
                        
                        <div class="form-group">
                            <label>Cl√© Ma√Ætre (Fernet)</label>
                            <div class="input-with-button">
                                <input type="password" id="master-key" placeholder="gAAAAAB...">
                                <button onclick="togglePassword('master-key')" class="btn-icon">üëÅÔ∏è</button>
                                <button onclick="generateMasterKey()" class="btn-secondary">üîÑ G√©n√©rer</button>
                            </div>
                            <span class="help-text">Format: gAAAAAB... (44 caract√®res base64)</span>
                        </div>

                        <div class="form-actions">
                            <button onclick="saveMasterKey()" class="btn-primary">üíæ Sauvegarder la cl√© ma√Ætre</button>
                            <button onclick="testMasterKey()" class="btn-secondary">üß™ Tester</button>
                        </div>
                    </div>

                    <!-- API Keys Section -->
                    <div class="config-section">
                        <h3>üîë Cl√©s API</h3>
                        <p class="config-description">Ces cl√©s sont chiffr√©es avant stockage. Utilisez "Tester" pour v√©rifier leur validit√©.</p>

                        <!-- Gemini -->
                        <div class="api-key-card">
                            <div class="api-key-header">
                                <span class="api-icon">üß†</span>
                                <div>
                                    <h4>Google Gemini</h4>
                                    <span class="api-status" id="gemini-status">Non configur√©</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Cl√© API Gemini</label>
                                <div class="input-with-button">
                                    <input type="password" id="gemini-key" placeholder="AIzaSy...">
                                    <button onclick="togglePassword('gemini-key')" class="btn-icon">üëÅÔ∏è</button>
                                    <button onclick="testGeminiKey()" class="btn-secondary">üß™ Tester</button>
                                </div>
                            </div>
                        </div>

                        <!-- Stripe -->
                        <div class="api-key-card">
                            <div class="api-key-header">
                                <span class="api-icon">üí≥</span>
                                <div>
                                    <h4>Stripe</h4>
                                    <span class="api-status" id="stripe-status">Non configur√©</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Cl√© Secr√®te Stripe (sk_test_... ou sk_live_...)</label>
                                <div class="input-with-button">
                                    <input type="password" id="stripe-key" placeholder="sk_test_...">
                                    <button onclick="togglePassword('stripe-key')" class="btn-icon">üëÅÔ∏è</button>
                                    <button onclick="testStripeKey()" class="btn-secondary">üß™ Tester</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Webhook Secret (whsec_...)</label>
                                <div class="input-with-button">
                                    <input type="password" id="stripe-webhook-key" placeholder="whsec_...">
                                    <button onclick="togglePassword('stripe-webhook-key')" class="btn-icon">üëÅÔ∏è</button>
                                </div>
                            </div>
                        </div>

                        <!-- Discord -->
                        <div class="api-key-card">
                            <div class="api-key-header">
                                <span class="api-icon">üí¨</span>
                                <div>
                                    <h4>Discord Bot</h4>
                                    <span class="api-status" id="discord-status">Non configur√©</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Token Discord</label>
                                <div class="input-with-button">
                                    <input type="password" id="discord-token" placeholder="MTA...">
                                    <button onclick="togglePassword('discord-token')" class="btn-icon">üëÅÔ∏è</button>
                                    <button onclick="testDiscordToken()" class="btn-secondary">üß™ Tester</button>
                                </div>
                            </div>
                        </div>

                        <!-- Supabase -->
                        <div class="api-key-card">
                            <div class="api-key-header">
                                <span class="api-icon">üóÑÔ∏è</span>
                                <div>
                                    <h4>Supabase</h4>
                                    <span class="api-status" id="supabase-status">Non configur√©</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>URL Supabase</label>
                                <input type="url" id="supabase-url-config" placeholder="https://xxxx.supabase.co">
                            </div>
                            <div class="form-group">
                                <label>Cl√© Service (service_role)</label>
                                <div class="input-with-button">
                                    <input type="password" id="supabase-key-config" placeholder="eyJ...">
                                    <button onclick="togglePassword('supabase-key-config')" class="btn-icon">üëÅÔ∏è</button>
                                    <button onclick="testSupabaseKey()" class="btn-secondary">üß™ Tester</button>
                                </div>
                            </div>
                        </div>

                        <!-- Redis (Optional) -->
                        <div class="api-key-card">
                            <div class="api-key-header">
                                <span class="api-icon">‚ö°</span>
                                <div>
                                    <h4>Redis (Optionnel)</h4>
                                    <span class="api-status" id="redis-status">Non configur√©</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>URL Redis</label>
                                <input type="text" id="redis-url" placeholder="redis://localhost:6379/0">
                                <span class="help-text">Laisser vide pour utiliser Supabase comme fallback</span>
                            </div>
                        </div>

                        <div class="form-actions main-actions">
                            <button onclick="saveAllKeys()" class="btn-primary btn-large">üíæ Sauvegarder toutes les cl√©s</button>
                            <button onclick="exportConfig()" class="btn-secondary btn-large">üì• Exporter .env</button>
                            <button onclick="importConfig()" class="btn-secondary btn-large">üì§ Importer .env</button>
                        </div>
                    </div>

                    <!-- Audit Log -->
                    <div class="config-section">
                        <h3>üìã Historique des Modifications</h3>
                        <div class="table-container">
                            <table id="config-logs-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Admin</th>
                                        <th>Action</th>
                                        <th>D√©tails</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="loading">Chargement...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Overlay de v√©rification d'authentification -->
    <div id="auth-check-overlay" class="auth-check-overlay">
        <div class="spinner"></div>
        <p>V√©rification de l'authentification...</p>
    </div>

    <!-- User Action Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h2>Modifier l'utilisateur</h2>
            <input type="hidden" id="edit-user-id">
            <label>Plan:</label>
            <select id="edit-user-plan">
                <option value="free">Free</option>
                <option value="basic">Basic</option>
                <option value="pro">Pro</option>
                <option value="ultra">Ultra</option>
            </select>
            <div class="modal-actions">
                <button onclick="saveUser()" class="btn-primary">Sauvegarder</button>
                <button onclick="closeModal()" class="btn-secondary">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Protections avanc√©es contre attaques complexes -->
    <script src="security-advanced.js"></script>
    
    <!-- Scripts applicatifs -->
    <script src="auth.js"></script>
    <script src="app.js"></script>
</body>
</html>
